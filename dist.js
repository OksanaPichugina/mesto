(()=>{"use strict";const e=document.querySelector("#open-popup"),t=document.querySelector("#name-input"),s=document.querySelector("#job-input"),o=document.querySelector("#edit-form"),r={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__submit",inactiveButtonClass:"popup__button-save__inactive",inputErrorClass:"form__input_error",errorClass:"popup__input-error_active"},n=document.querySelector("#open-avatar-popup"),i=document.querySelector("#avatar-popup"),l=(document.querySelector("#avatar-input"),document.querySelector("#add-form")),a=document.querySelector("#open-popup-add-button");class h{constructor(e,t,s,o,r,n){console.log(e),this._text=e.name,this._link=e.link,this._templateSelector=t,this._element=this._getTemplate(),this._elemImage=this._element.querySelector(".element__image"),this._handleCardClick=s,this._buttonLike=this._element.querySelector(".element__like_button"),this._buttonDelete=this._element.querySelector(".element__delite"),this._id=e._id,this._handleDelete=o,this._cardOwnerId=e.owner._id,this._ownerId=r,this._quantityLikes=e.likes.length,this._handleLikeClick=n,this._likes=e.likes}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".element").cloneNode(!0)}getView(){return this._setEventListeners(),this.activeButtonDelete(),this._elemImage.src=this._link,this._element.querySelector(".element__name").querySelector(".element__text").textContent=this._text,this._elemImage.alt=this._text,this._checkLike(),this._element.querySelector(".element__like").querySelector(".element__like_count").textContent=this._quantityLikes,this._element}remove(){console.log(this._id),this._handleDelete(this._id)}activeButtonDelete(){this._ownerId===this._cardOwnerId&&this._buttonDelete.classList.add("element__delite_active")}like(){let e;e=!!this._buttonLike.classList.contains("element__like_button_active"),this._handleLikeClick(this._id,e)}likeCard(){console.log("сработало"),this._buttonLike.classList.toggle("element__like_button_active"),this._element.querySelector(".element__like").querySelector(".element__like_count").textContent=this._quantityLikes}_checkLike(){this._likes.forEach((e=>{(this._cardOwnerId=e._id)&&this._buttonLike.classList.add("element__like_button_active")}))}_setEventListeners(){this._elemImage.addEventListener("click",(()=>{this._handleCardClick()})),this._buttonDelete.addEventListener("click",(()=>this.remove())),this._buttonLike.addEventListener("click",(()=>this.like()))}deleteCard(){this._element.remove(),this._element=null}}class c{constructor(e){this._selector=e,this.popup=document.querySelector(this._selector),this._buttonClose=this.popup.querySelector(".popup__close-button"),this._handleEscClose=this._handleEscClose.bind(this),this._buttonSave=this.popup.querySelector(".popup__button-save")}open(){this.popup.classList.add("popup_opened"),window.addEventListener("keydown",this._handleEscClose)}close(){this.popup.classList.remove("popup_opened"),window.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){27===e.keyCode&&this.close()}setEventListener(){this._buttonClose.addEventListener("click",(()=>this.close())),this.popup.addEventListener("click",(e=>{e.target.classList.contains("popup")&&this.close()}))}uxForm(){this._buttonSave.textContent="Сохранение..."}}class u extends c{constructor(e,{callback:t}){super(e),this._inputs=this.popup.querySelectorAll(".popup__input"),this._callback=t,this._fom=this.popup.querySelector(".popup__form")}setEventListener(){super.setEventListener(),this.popup.addEventListener("submit",(e=>{e.preventDefault(),this.uxForm(),this._callback(this._getInputValues())}))}open(){super.open()}close(){super.close(),this._fom.reset()}_getInputValues(){const e={};return this._inputs.forEach((t=>{const s=t.name,o=t.value;e[s]=o})),e}}class _{constructor(e,t){this._formSelectors=e,this._formElem=t,this._formList=Array.from(this._formElem.querySelectorAll(this._formSelectors.inputSelector)),this._button=this._formElem.querySelector(this._formSelectors.submitButtonSelector)}enableValidation(){this._formElem.addEventListener("submit",(e=>e.preventDefault())),this._setEventListeners()}_showInputError(e,t){const s=this._formElem.querySelector(`.${e.id}-error`);e.classList.add(this._formSelectors.inputErrorClass),s.textContent=t,s.classList.add(this._formSelectors.errorClass)}_hideInputError=e=>{const t=this._formElem.querySelector(`.${e.id}-error`);e.classList.remove(this._formSelectors.inputErrorClass),t.classList.remove(this._formSelectors.errorClass),t.textContent=""};_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_setEventListeners(){this._formList.forEach((e=>{this.toggleButtonState(),e.addEventListener("input",(()=>{this._checkInputValidity(e),this.toggleButtonState()}))}))}_hasInvalidInput(){return this._formList.some((e=>!e.validity.valid))}toggleButtonState(){this._hasInvalidInput()?(this._button.classList.add(this._formSelectors.inactiveButtonClass),this._button.setAttribute("disabled","true")):(this._button.classList.remove(this._formSelectors.inactiveButtonClass),this._button.removeAttribute("disabled"))}}class p{constructor({url:e,headers:t}){this._url=e,this._headers=t}getMethod(){return fetch(this._url,{method:"GET",headers:this._headers}).then((e=>{if(e.ok)return e.json();throw new Error("Что-то пошло не так")})).catch((e=>{console.log(e)}))}postCard(e,t){return fetch(this._url,{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then((e=>{if(e.ok)return e.json();throw new Error("Что-то пошло не так")})).catch((e=>{console.log(e)}))}patchMethod(e,t){return fetch(this._url,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then((e=>{if(e.ok)return e.json();throw new Error("Что-то пошло не так")})).catch((e=>{console.log(e)}))}patchAvatar(e){return fetch(`${this._url}/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then((e=>{if(e.ok)return e.json();throw new Error("Что-то пошло не так")})).catch((e=>{console.log(e)}))}deleteMethod(e){return fetch(`${this._url}/${e}`,{method:"DELETE",headers:this._headers}).then((e=>{if(e.ok)return e.json();throw new Error("Что-то пошло не так")})).catch((e=>{console.log(e)}))}putLike(e){return fetch(`${this._url}/${e}/likes`,{method:"PUT",headers:this._headers}).then((e=>{if(e.ok)return e.json();throw new Error("Что-то пошло не так")})).catch((e=>{console.log(e)}))}removeLike(e){return fetch(`${this._url}/${e}/likes`,{method:"DELETE",headers:this._headers}).then((e=>{if(e.ok)return e.json();throw new Error("Что-то пошло не так")})).catch((e=>{console.log(e)}))}}const d=new _(r,l);d.enableValidation(),new _(r,o).enableValidation(),new _(r,i).enableValidation();const m=new class{constructor(e,t,s){this.name=document.querySelector(e),this.job=document.querySelector(t),this.avatar=document.querySelector(s)}getUserInfo(){return{name:this.name.textContent,job:this.job.textContent,avatar:this.avatar.src}}setUserInfo(e,t,s){this.name.textContent=e,this.job.textContent=t,this.avatar.src=s}}(".profile__name",".profile__job",".profile__avatar"),v=new p({url:"https://nomoreparties.co/v1/cohort-75/cards",headers:{authorization:"2f4a0f3f-0cc6-4586-a3d5-35eed1a37f2e","Content-Type":"application/json"}}),k=new p({url:"https://nomoreparties.co/v1/cohort-75/users/me",headers:{authorization:"2f4a0f3f-0cc6-4586-a3d5-35eed1a37f2e","Content-Type":"application/json"}});let f="";k.getMethod().then((e=>{m.setUserInfo(e.name,e.about,e.avatar),f=e._id}));const E=new u("#edit-popup",{callback:e=>{k.patchMethod(e.name,e.job).then((e=>{m.setUserInfo(e.name,e.about,e.avatar)})),m.setUserInfo(e.name,e.job,""),E.close()}}),b=new u("#avatar-popup",{callback:e=>{k.patchAvatar(e.avatar).then((e=>{m.setUserInfo(e.name,e.about,e.avatar)})),b.close()}});E.setEventListener(),e.addEventListener("click",(()=>{E.open();const e=m.getUserInfo();t.value=e.name,s.value=e.job})),b.setEventListener(),n.addEventListener("click",(()=>{b.open()}));const L=new class extends c{constructor(e){super(e),this._popupImage=this.popup.querySelector(".popup__image"),this._popupText=this.popup.querySelector(".popup__text")}open(e){super.open(),this._popupImage.src=e.link,this._popupText.textContent=e.name,this._popupImage.alt=e.name}}("#image-popup"),S=new class extends c{constructor(e,t){super(e),this._deleteCard=t}setEventListener(e,t){super.setEventListener(),this.popup.addEventListener("submit",(s=>{s.preventDefault(),this.uxForm(),this._deleteCard(e,t)}))}}("#submit-popup",((e,t)=>{v.deleteMethod(t).then((()=>{e.deleteCard()})).then((()=>{S.close()}))}));function y(e){const t=new h(e,"#element-template",(()=>{L.open(e),L.setEventListener()}),(e=>{S.open(),S.setEventListener(t,e)}),f,((e,s)=>{s?v.removeLike(e).then((()=>{t.likeCard(),t.getView()})):v.putLike(e).then((()=>{t.likeCard(),t.getView()}))}));return t.getView()}const g=new class{constructor({renderer:e},t){this._renderer=e,this._container=document.querySelector(t)}addItem(e){this._container.prepend(e)}clear(){this._container.innerHTML=""}renderItems(e){e.forEach((e=>{this._renderer(e)}))}}({renderer:e=>{g.addItem(y(e))}},".elements__list");v.getMethod().then((e=>{g.renderItems(e)}));const C=new u("#add-popup",{callback:e=>{const t=e.place,s=e.link;v.postCard(t,s).then((e=>{E.uxForm();const t=y(e);console.log(t),g.addItem(t)})),b.uxForm(),C.close(),d.toggleButtonState()}});C.setEventListener(),a.addEventListener("click",(()=>{C.open()}))})();